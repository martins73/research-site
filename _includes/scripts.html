<script>
(function () {
  "use strict";

  function isMobile() {
    return window.matchMedia("(max-width: 768px)").matches;
  }

  /* ==========================================================================
     0. MOBILE: SCROLL DOWN FROM SIDEBAR AFTER NAV TAP
     Fixes the "jump up then smooth down" and survives includes/refactors.
     ========================================================================== */

  function attachSidebarNavFlag() {
    if (!isMobile()) return;

    const handler = function (e) {
      const link = e.target.closest("a");
      if (!link) return;

      if (link.classList && link.classList.contains("sidebar-nav")) {
        sessionStorage.setItem("autoScrollToContent", "1");
      }
    };

    document.addEventListener("click", handler, true);
    document.addEventListener("touchend", handler, { capture: true, passive: true });
  }

  function runAutoScrollIfFlagged() {
    if (!isMobile()) return;

    const shouldAutoScroll = sessionStorage.getItem("autoScrollToContent") === "1";
    if (!shouldAutoScroll) return;

    sessionStorage.removeItem("autoScrollToContent");

    const main = document.getElementById("main-content");
    if (!main) return;

    if ("scrollRestoration" in history) {
      history.scrollRestoration = "manual";
    }

    requestAnimationFrame(function () {
      const y = main.getBoundingClientRect().top + window.scrollY - 20;
      window.scrollTo({ top: y, left: 0, behavior: "smooth" });
    });
  }

  /* ==========================================================================
     1. SPINNING PROFILE PICTURE
     ========================================================================== */

  function setupProfileSpin() {
    const profilePic = document.querySelector(".js-spin-trigger");
    if (!profilePic) return;

    const SPIN_DURATION = 3200;
    profilePic.style.cursor = "pointer";
    profilePic.addEventListener("click", function () {
      profilePic.classList.add("spin-effect");
      setTimeout(function () {
        profilePic.classList.remove("spin-effect");
      }, SPIN_DURATION);
    });
  }

  /* ==========================================================================
     2. FAMILY DYNAMIC MODAL WITH ACCESSIBILITY
     ========================================================================== */

  function setupFamilyModal() {
    const modal = document.getElementById("family-modal");
    const modalImg = document.getElementById("modal-img");
    const modalCaption = document.getElementById("modal-caption");
    const closeButton = document.getElementById("modal-close");
    const triggers = document.querySelectorAll(".family-link");

    const familyData = {{ site.data.family | jsonify }};

    if (!modal || triggers.length === 0 || !familyData) return;

    let lastFocusedElement = null;

    function openModal(personKey) {
      const personData = familyData[personKey];
      if (!personData) return;

      lastFocusedElement = document.activeElement;

      modalImg.src = personData.img;
      modalImg.alt = personData.text;
      modalCaption.innerText = personData.text;

      modal.style.display = "flex";
      modal.setAttribute("aria-hidden", "false");

      if (closeButton) closeButton.focus();

      document.body.style.overflow = "hidden";
    }

    function closeModal() {
      modal.style.display = "none";
      modal.setAttribute("aria-hidden", "true");

      document.body.style.overflow = "";

      modalImg.src = "";
      modalImg.alt = "";
      modalCaption.innerText = "";

      if (lastFocusedElement) lastFocusedElement.focus();
    }

    triggers.forEach(function (trigger) {
      trigger.setAttribute("role", "button");
      trigger.setAttribute("tabindex", "0");
      trigger.setAttribute("aria-haspopup", "dialog");

      trigger.addEventListener("click", function (e) {
        e.preventDefault();
        const personKey = this.getAttribute("data-person");
        openModal(personKey);
      });

      trigger.addEventListener("keydown", function (e) {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          const personKey = this.getAttribute("data-person");
          openModal(personKey);
        }
      });
    });

    if (closeButton) closeButton.addEventListener("click", closeModal);

    modal.addEventListener("click", function (e) {
      if (e.target === modal) closeModal();
    });

    document.addEventListener("keydown", function (e) {
      if (e.key === "Escape" && modal.style.display === "flex") {
        closeModal();
      }
    });

    modal.addEventListener("keydown", function (e) {
      if (e.key !== "Tab") return;

      const focusableElements = modal.querySelectorAll(
        'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
      );

      if (focusableElements.length === 0) return;

      const firstElement = focusableElements[0];
      const lastElement = focusableElements[focusableElements.length - 1];

      if (e.shiftKey) {
        if (document.activeElement === firstElement) {
          e.preventDefault();
          lastElement.focus();
        }
      } else {
        if (document.activeElement === lastElement) {
          e.preventDefault();
          firstElement.focus();
        }
      }
    });
  }

  /* ==========================================================================
     3. DARK MODE TOGGLE
     ========================================================================== */

  function setupThemeToggle() {
    const themeToggle = document.getElementById("theme-toggle");
    if (!themeToggle) return;

    function getCurrentTheme() {
      return document.documentElement.getAttribute("data-theme") || "light";
    }

    function setTheme(theme) {
      document.documentElement.setAttribute("data-theme", theme);
      localStorage.setItem("theme", theme);

      if (theme === "dark") {
        themeToggle.setAttribute("aria-label", "Switch to light mode");
        themeToggle.setAttribute("title", "Switch to light mode");
      } else {
        themeToggle.setAttribute("aria-label", "Switch to dark mode");
        themeToggle.setAttribute("title", "Switch to dark mode");
      }
    }

    themeToggle.addEventListener("click", function () {
      const currentTheme = getCurrentTheme();
      const newTheme = currentTheme === "dark" ? "light" : "dark";
      setTheme(newTheme);
    });

    if (getCurrentTheme() === "dark") {
      themeToggle.setAttribute("aria-label", "Switch to light mode");
      themeToggle.setAttribute("title", "Switch to light mode");
    }
  }

  /* ==========================================================================
     4. LITURGICAL CALENDAR HOVER (data from _data/saints.yml)
     Expected YAML shape:
       "1-1":
         - "Mary, the Holy Mother of God"
       "6-29":
         - "Saints Peter and Paul"
     ========================================================================== */

  function setupSaintHover() {
    const trigger = document.getElementById("saint-trigger");
    const target = document.getElementById("copyright-content");
    if (!trigger || !target) return;

    const today = new Date();
    const key = String(today.getMonth() + 1) + "-" + String(today.getDate());

    const saintsByDay = {{ site.data.saints | jsonify }};

    const saints = saintsByDay ? saintsByDay[key] : null;
    const originalText = target.innerText;

    if (!saints || !Array.isArray(saints) || saints.length === 0) return;

    function joinSaints(list) {
      if (list.length === 1) return list[0];
      if (list.length === 2) return list[0] + " and " + list[1];
      return list.slice(0, -1).join(", ") + ", and " + list[list.length - 1];
    }

    const saintText = joinSaints(saints);

    trigger.addEventListener("mouseenter", function () {
      target.style.transition = "opacity 0.2s";
      target.style.opacity = "0";

      setTimeout(function () {
        target.innerText = "Feast of " + saintText;
        target.style.color = "#2774AE";
        target.style.fontWeight = "500";
        target.style.opacity = "1";
      }, 200);
    });

    trigger.addEventListener("mouseleave", function () {
      target.style.transition = "opacity 0.2s";
      target.style.opacity = "0";

      setTimeout(function () {
        target.innerText = originalText;
        target.style.color = "inherit";
        target.style.fontWeight = "normal";
        target.style.opacity = "1";
      }, 200);
    });
  }

  /* ==========================================================================
     INIT
     ========================================================================== */

  function init() {
    attachSidebarNavFlag();
    runAutoScrollIfFlagged();
    setupProfileSpin();
    setupFamilyModal();
    setupThemeToggle();
    setupSaintHover();
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", init);
  } else {
    init();
  }

  window.addEventListener("pageshow", function () {
    runAutoScrollIfFlagged();
  });

  console.log(
    "%cðŸ‘‹ Hi, I'm {{ site.author.given_name }}.\n%cInterested in my code? Check out the repo: {{ site.social.github }}",
    "color: #2774AE; font-size: 20px; font-weight: bold; font-family: sans-serif;",
    "color: #64748b; font-size: 12px; font-family: sans-serif;"
  );
})();
</script>