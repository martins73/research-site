<script>
  console.log("Scripts.html loaded");

  document.addEventListener("DOMContentLoaded", function () {
    console.log("DOMContentLoaded fired");

    /* 0. MOBILE: SCROLL FROM SIDEBAR TO CONTENT (NO FLASH) */
    console.log("Window width:", window.innerWidth);
    const isMobile = window.matchMedia("(max-width: 768px)").matches;
    console.log("Is mobile (768px check):", isMobile);

    if (isMobile) {
      const sidebar = document.querySelector(".sidebar");
      console.log("Sidebar found:", sidebar ? "yes" : "no");

      document.querySelectorAll(".sidebar .sidebar-nav").forEach(link => {
        link.addEventListener("click", () => {
          // Always set the flag - we'll decide on the new page whether to animate
          console.log("Sidebar link clicked, setting autoScrollToContent flag");
          sessionStorage.setItem("autoScrollToContent", "1");
        });
      });

      const shouldAutoScroll = sessionStorage.getItem("autoScrollToContent") === "1";
      console.log("Should auto scroll:", shouldAutoScroll);

      if (shouldAutoScroll) {
        console.log("Performing auto-scroll to main content");
        sessionStorage.removeItem("autoScrollToContent");

        const main = document.getElementById("main-content");
        console.log("Main content element found:", main ? "yes" : "no");
        if (main) {
          const y = main.getBoundingClientRect().top + window.scrollY - 20;
          const sidebarTop = sidebar.getBoundingClientRect().top;
          console.log("Main content position:", main.getBoundingClientRect().top);
          console.log("Current scroll Y:", window.scrollY);
          console.log("Sidebar top on new page:", sidebarTop);
          console.log("Scrolling to position:", y);

          // If sidebar is visible at top, use smooth scroll to show animation
          // If sidebar is not at top, use instant scroll to go directly to content
          const useSmoothScroll = sidebarTop >= 0 && sidebarTop < 100;
          console.log("Using smooth scroll:", useSmoothScroll);

          window.scrollTo({
            top: y,
            behavior: useSmoothScroll ? "smooth" : "auto"
          });
        } else {
          console.log("Main content element not found");
        }
      } else {
        console.log("Auto-scroll flag not set, loading page normally");
      }
    }

    
    /* 1. SPINNING PROFILE PICTURE */
    const profilePic = document.querySelector(".js-spin-trigger");
    if (profilePic) {
      const SPIN_DURATION = 3200;
      profilePic.style.cursor = "pointer";
      profilePic.addEventListener("click", function () {
        profilePic.classList.add("spin-effect");
        setTimeout(() => {
          profilePic.classList.remove("spin-effect");
        }, SPIN_DURATION);
      });
    }

    /* 2. FAMILY DYNAMIC MODAL WITH ACCESSIBILITY */
    const modal = document.getElementById("family-modal");
    const modalImg = document.getElementById("modal-img");
    const modalCaption = document.getElementById("modal-caption");
    const closeButton = document.getElementById("modal-close");
    const triggers = document.querySelectorAll(".family-link");

    const familyData = {{ site.data.family | jsonify }};

    if (modal && triggers.length > 0 && familyData) {
      let lastFocusedElement = null;

      const openModal = (personKey) => {
        const personData = familyData[personKey];
        if (!personData) return;

        lastFocusedElement = document.activeElement;

        modalImg.src = personData.img;
        modalImg.alt = personData.text;
        modalCaption.innerText = personData.text;

        modal.style.display = "flex";
        modal.setAttribute("aria-hidden", "false");

        if (closeButton) closeButton.focus();

        document.body.style.overflow = "hidden";
      };

      const closeModal = () => {
        modal.style.display = "none";
        modal.setAttribute("aria-hidden", "true");

        document.body.style.overflow = "";

        modalImg.src = "";
        modalImg.alt = "";
        modalCaption.innerText = "";

        if (lastFocusedElement) lastFocusedElement.focus();
      };

      triggers.forEach((trigger) => {
        trigger.setAttribute("role", "button");
        trigger.setAttribute("tabindex", "0");
        trigger.setAttribute("aria-haspopup", "dialog");

        trigger.addEventListener("click", function (e) {
          e.preventDefault();
          const personKey = this.getAttribute("data-person");
          openModal(personKey);
        });

        trigger.addEventListener("keydown", function (e) {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            const personKey = this.getAttribute("data-person");
            openModal(personKey);
          }
        });
      });

      if (closeButton) closeButton.addEventListener("click", closeModal);

      modal.addEventListener("click", function (e) {
        if (e.target === modal) closeModal();
      });

      document.addEventListener("keydown", function (e) {
        if (e.key === "Escape" && modal.style.display === "flex") {
          closeModal();
        }
      });

      modal.addEventListener("keydown", function (e) {
        if (e.key === "Tab") {
          const focusableElements = modal.querySelectorAll(
            'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
          );

          if (focusableElements.length === 0) return;

          const firstElement = focusableElements[0];
          const lastElement = focusableElements[focusableElements.length - 1];

          if (e.shiftKey) {
            if (document.activeElement === firstElement) {
              e.preventDefault();
              lastElement.focus();
            }
          } else {
            if (document.activeElement === lastElement) {
              e.preventDefault();
              firstElement.focus();
            }
          }
        }
      });
    }

    /* 3. DARK MODE TOGGLE */
    const themeToggle = document.getElementById("theme-toggle");
    if (themeToggle) {
      const getCurrentTheme = () => {
        return document.documentElement.getAttribute("data-theme") || "light";
      };

      const setTheme = (theme) => {
        document.documentElement.setAttribute("data-theme", theme);
        localStorage.setItem("theme", theme);

        if (theme === "dark") {
          themeToggle.setAttribute("aria-label", "Switch to light mode");
          themeToggle.setAttribute("title", "Switch to light mode");
        } else {
          themeToggle.setAttribute("aria-label", "Switch to dark mode");
          themeToggle.setAttribute("title", "Switch to dark mode");
        }
      };

      themeToggle.addEventListener("click", () => {
        const currentTheme = getCurrentTheme();
        const newTheme = currentTheme === "dark" ? "light" : "dark";
        setTheme(newTheme);
      });

      const initialTheme = getCurrentTheme();
      if (initialTheme === "dark") {
        themeToggle.setAttribute("aria-label", "Switch to light mode");
        themeToggle.setAttribute("title", "Switch to light mode");
      }
    }

    /* 4. SAINT OF THE DAY (FOOTER HOVER) */
    const trigger = document.getElementById("saint-trigger");
    const target = document.getElementById("copyright-content");
    if (trigger && target) {
      const today = new Date();
      const key = (today.getMonth() + 1) + "-" + today.getDate();

      const saintsByDay = {{ site.data.saints | jsonify }};
      const saints = saintsByDay ? saintsByDay[key] : null;

      const originalHTML = target.innerHTML;
      const originalText = target.innerText;

      const formatSaintList = (arr) => {
        if (!arr || arr.length === 0) return "";
        if (arr.length === 1) return arr[0];

        const cleaned = arr.map((s) => (s || "").trim()).filter(Boolean);

        const allStartWithSaint = cleaned.every((s) => /^Saint\s+/i.test(s));
        const allStartWithBlessed = cleaned.every((s) => /^Blessed\s+/i.test(s));

        const stripPrefix = (s, prefixRegex) => s.replace(prefixRegex, "").trim();

        if (allStartWithSaint) {
          const names = cleaned.map((s) => stripPrefix(s, /^Saint\s+/i));
          return "Saints " + names.join(" and ");
        }

        if (allStartWithBlessed) {
          const names = cleaned.map((s) => stripPrefix(s, /^Blessed\s+/i));
          return "Blesseds " + names.join(" and ");
        }

        return cleaned.join(" and ");
      };

      if (saints && saints.length > 0) {
        const saintText = formatSaintList(saints);

        trigger.addEventListener("mouseenter", () => {
          target.style.transition = "opacity 0.2s";
          target.style.opacity = "0";

          setTimeout(() => {
            target.innerText = "Feast of " + saintText;
            target.style.color = "#2774AE";
            target.style.fontWeight = "500";
            target.style.opacity = "1";
          }, 200);
        });

        trigger.addEventListener("mouseleave", () => {
          target.style.transition = "opacity 0.2s";
          target.style.opacity = "0";

          setTimeout(() => {
            if (originalHTML !== originalText) {
              target.innerHTML = originalHTML;
            } else {
              target.innerText = originalText;
            }
            target.style.color = "inherit";
            target.style.fontWeight = "normal";
            target.style.opacity = "1";
          }, 200);
        });
      }
    }
  });

  console.log(
    "%cðŸ‘‹ Hi, I'm {{ site.author.given_name }}.\n%cInterested in my code? Check out the repo: {{ site.social.github }}",
    "color: #2774AE; font-size: 20px; font-weight: bold; font-family: sans-serif;",
    "color: #64748b; font-size: 12px; font-family: sans-serif;"
  );
</script>